# Cover images from media players

Starting with version 2.2.0,
Music Presence uses cover images from music players by default
instead of relying on external API services to get an image for the album cover
of the currently playing song.
Previously the TIDAL API and MusicBrainz API was used to get cover images,
these are now obsolete and are only used to get further song information,
like additional artists or a missing album name.

This has the following benefits:

- There is always a cover image available,
  no matter which media player you are using.
- The status will always show the correct cover image.
  Previously it was possible that an incorrect album cover was shown
  because the media player did not report the album the song was playing from,
  which made it impossible to select the correct image.
- If you are listening to MP3 or FLAC files,
  the embedded cover image will be used.
- There is no need for making requests to external services/APIs
  just for a cover image anymore.

All of this is of course only the case,
if your media player reports a cover image.

## How it works

When the media player that plays the current song supplies an image
and it is not possible to determine the correct album image
using an external API service,
then Music Presence performs the following steps,
to show the cover image from the media player in your Discord status:

- Music Presence connects to a custom-designed Proxy server,
  for the time that the cover image from your media player
  should be displayed in your Discord status.
- A random, internet-accessible URL is generated,
  which will serve the media player's cover image, when requested.
  This URL is then sent to Discord to be used in the status as the large image.
  This process is instant and has no extra delays.
- As soon as Discord sends a request to that URL,
  in order to display the image in the status,
  the Proxy server will forward that request to the Music Presence application.
  Once Music Presence receives that forwarded request,
  it will respond by sending the image information
  back to Discord through the Proxy server.
  The image is cropped to a 100x100 center square before being sent.
  This amounts to about 20-30 KB in most cases,
  which should be handled just fine be any decent internet connection.
- The Proxy server stores the image
  for a very short duration (less than a minute)
  and is discarded after that duration.
  No image data is stored permanently.
  The server is only used as an intermediary to send the image to Discord,
  as Discord does not provide any mechanism to upload images for your status.
- Once you stop listening to music
  or when the server connection is not needed anymore,
  Music Presence disconnects from the Proxy server.

Since this feature implements a "Proxy",
it is theoretically possible that Music Presence users
are spammed with forwarded requests from the Proxy server,
if a malicious actor gets hold of one or more generated URLs.

A number of techniques are employed to prevent this from happening:

- The application only responds to forwarded requests
  which come from URLs that were actually generated by Music Presence.
  If Music Presence never generates a URL, then it never gets any request.
- The response for a request to a generated URL is cached on the server
  for a short duration (30 seconds at the time of writing).
  This ensures that the application can get *at most*
  one forwarded request for that duration
  and cannot be spammed with requests for a single generated URL.
- Due to the way the system was designed,
  old generated URLs cannot be revoked and will be forwarded to Music Presence,
  even when they are not in use anymore.
  In those cases Music Presence will respond with empty content
  and not upload any data.
  A malicious actor could collect these URLs and request them all at once.
  To prevent serving too many old URLs,
  if too many are requested within a given time frame,
  the connection is simply closed and restarted.
  Closing the connection revokes any generated URLs.
  This should not happen in practice,
  but it is being handled, just in case.

## Source code

The logic behind this is rather complex
and has been decoupled from Music Presence in its own server and library:

- **ungive/loon**  - *local files online*  
  loon enables you to temporarily host a local file online via HTTP, without exposing your device to the internet, by using the bare minimum of resources needed.  
  **[https://github.com/ungive/loon](https://github.com/ungive/loon)**

---

Last updated: 27.08.2024
